<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Full Chess with Check, Castling & Promotion</title>
<style>
body {margin:0; display:flex; justify-content:center; align-items:flex-start; background:#2b2b2b; font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif; color:#fff; user-select:none;}
#container{display:flex; flex-wrap:wrap; justify-content:center; margin-top:20px;}
#chessboard{display:grid; grid-template-columns:repeat(8,64px); grid-template-rows:repeat(8,64px); border:2px solid #333; position:relative; box-shadow:0 0 10px rgba(0,0,0,0.5);}
.square{width:64px;height:64px; display:flex; justify-content:center; align-items:center; transition:background 0.2s;}
.white{background:#f0d9b5;}
.black{background:#b58863;}
.highlight{background:rgba(255,255,0,0.5)!important;}
.in-check{background:rgba(255,0,0,0.5)!important;}
.piece{position:absolute;width:64px;height:64px; cursor:grab; transition:top 0.2s,left 0.2s,transform 0.2s;}
.piece:hover{transform:scale(1.1);}
#side-panel{display:flex; flex-direction:column; margin-left:20px; max-width:220px;}
#history{width:100%; max-height:300px; overflow-y:auto; background:#1e1e1e; border-radius:8px; margin-bottom:10px; padding:10px;}
#history h3{text-align:center; margin-top:0; color:#00bfff;}
#history ol{padding-left:20px;}
#history li{margin-bottom:4px; color:#fff;}
#controls{display:flex; justify-content:space-between; margin-bottom:10px;}
button{background:#00bfff; border:none; color:#fff; padding:5px 10px; border-radius:4px; cursor:pointer;}
button:hover{background:#0099cc;}
#timers{display:flex; justify-content:space-between; margin-bottom:10px;}
.timer{background:#1e1e1e; padding:5px 10px; border-radius:4px; text-align:center;}
#promotion-overlay{position:absolute; display:none; background:#333; border:2px solid #666; z-index:200; padding:5px; border-radius:8px; flex-direction:row;}
.promo-piece{width:64px; height:64px; cursor:pointer; margin:2px;}
</style>
</head>
<body>
<div id="container">
<div id="chessboard"></div>
<div id="side-panel">
<div id="timers">
<div class="timer" id="whiteTimer">White: 10:00</div>
<div class="timer" id="blackTimer">Black: 10:00</div>
</div>
<div id="controls">
<button id="undoBtn">Undo</button>
<button id="redoBtn">Redo</button>
</div>
<div id="history"><h3>Move History</h3><ol id="moves"></ol></div>
</div>
</div>
<div id="promotion-overlay"></div>

<script>
// --- Setup ---
const boardEl = document.getElementById('chessboard');
const overlay = document.getElementById('promotion-overlay');
const movesList = document.getElementById('moves');

let board = [
["r","n","b","q","k","b","n","r"],
["p","p","p","p","p","p","p","p"],
["","","","","","","",""],
["","","","","","","",""],
["","","","","","","",""],
["","","","","","","",""],
["P","P","P","P","P","P","P","P"],
["R","N","B","Q","K","B","N","R"]
];

const pieceImages = {
"P":"https://upload.wikimedia.org/wikipedia/commons/0/04/Chess_plt45.svg",
"R":"https://upload.wikimedia.org/wikipedia/commons/5/5c/Chess_rlt45.svg",
"N":"https://upload.wikimedia.org/wikipedia/commons/2/28/Chess_nlt45.svg",
"B":"https://upload.wikimedia.org/wikipedia/commons/9/9b/Chess_blt45.svg",
"Q":"https://upload.wikimedia.org/wikipedia/commons/4/49/Chess_qlt45.svg",
"K":"https://upload.wikimedia.org/wikipedia/commons/3/3b/Chess_klt45.svg",
"p":"https://upload.wikimedia.org/wikipedia/commons/c/cd/Chess_pdt45.svg",
"r":"https://upload.wikimedia.org/wikipedia/commons/a/a0/Chess_rdt45.svg",
"n":"https://upload.wikimedia.org/wikipedia/commons/f/f1/Chess_ndt45.svg",
"b":"https://upload.wikimedia.org/wikipedia/commons/8/81/Chess_bdt45.svg",
"q":"https://upload.wikimedia.org/wikipedia/commons/a/af/Chess_qdt45.svg",
"k":"https://upload.wikimedia.org/wikipedia/commons/e/e3/Chess_kdt45.svg"
};

let currentTurn = "white";
let draggedPiece = null;
let draggedElement = null;
let moveHistory = [];
let castlingRights = {white:{K:true,Q:true}, black:{K:true,Q:true}};

// --- Helpers ---
function isWhite(piece){ return piece && piece===piece.toUpperCase(); }
function isBlack(piece){ return piece && piece===piece.toLowerCase(); }

function drawBoard(highlights=[], checkPos=null){
boardEl.innerHTML="";
for(let i=0;i<8;i++){
    for(let j=0;j<8;j++){
        const square=document.createElement('div');
        square.className='square '+((i+j)%2===0?'white':'black');
        square.dataset.row=i;
        square.dataset.col=j;
        if(highlights.some(pos=>pos[0]===i && pos[1]===j)) square.classList.add('highlight');
        if(checkPos && checkPos[0]===i && checkPos[1]===j) square.classList.add('in-check');
        boardEl.appendChild(square);

        const piece = board[i][j];
        if(piece){
            const img = document.createElement('img');
            img.src = pieceImages[piece];
            img.className='piece';
            img.dataset.row=i;
            img.dataset.col=j;
            img.dataset.type=piece;
            img.style.top=(i*64)+'px';
            img.style.left=(j*64)+'px';
            img.draggable=false;
            img.addEventListener('mousedown', mouseDown);
            boardEl.appendChild(img);
        }
    }
}
updateHistory();
}

function updateHistory(){
movesList.innerHTML="";
moveHistory.forEach(m=>{
    const li=document.createElement('li');
    li.textContent=m;
    movesList.appendChild(li);
});
}

// --- Legal Moves (simplified, with castling/promotion) ---
function getLegalMoves(r,c){
const piece=board[r][c];
if(!piece || (currentTurn==='white' && isBlack(piece)) || (currentTurn==='black' && isWhite(piece))) return [];
const moves=[];
const dirs={
'P':[[-1,0],[-2,0],[-1,-1],[-1,1]],
'p':[[1,0],[2,0],[1,-1],[1,1]],
'N':[[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]],
'n':[[-2,-1],[-2,1],[-1,-2],[-1,2],[1,-2],[1,2],[2,-1],[2,1]],
'B':[[-1,-1],[-1,1],[1,-1],[1,1]],
'b':[[-1,-1],[-1,1],[1,-1],[1,1]],
'R':[[-1,0],[1,0],[0,-1],[0,1]],
'r':[[-1,0],[1,0],[0,-1],[0,1]],
'Q':[[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[-1,1],[1,-1],[1,1]],
'q':[[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[-1,1],[1,-1],[1,1]],
'K':[[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[-1,1],[1,-1],[1,1]],
'k':[[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[-1,1],[1,-1],[1,1]]
};

if(piece==='P'||piece==='p'){
const forward = piece==='P'?-1:1;
if(board[r+forward] && board[r+forward][c]==='') moves.push([r+forward,c]);
if((r===6&&piece==='P')||(r===1&&piece==='p')) if(board[r+2*forward][c]==='') moves.push([r+2*forward,c]);
[[-1,1],[-1,-1]].forEach(d=>{
const dr=d[0]*forward, dc=d[1];
if(board[r+dr] && board[r+dr][c+dc] && isWhite(piece)!==isWhite(board[r+dr][c+dc])) moves.push([r+dr,c+dc]);
});
} else if('Nn'.includes(piece)){
dirs[piece].forEach(d=>{
const nr=r+d[0], nc=c+d[1];
if(nr>=0 && nr<8 && nc>=0 && nc<8 && (!board[nr][nc] || isWhite(piece)!==isWhite(board[nr][nc]))) moves.push([nr,nc]);
});
} else {
dirs[piece].forEach(d=>{
let nr=r+d[0], nc=c+d[1];
while(nr>=0 && nr<8 && nc>=0 && nc<8){
if(!board[nr][nc]) moves.push([nr,nc]);
else{ if(isWhite(piece)!==isWhite(board[nr][nc])) moves.push([nr,nc]); break;}
if('Kk'.includes(piece)) break;
nr+=d[0]; nc+=d[1];
}
});
}
// Castling (simplified, without check detection)
if(piece==='K' && castlingRights.white.K && board[7][5]==='' && board[7][6]==='') moves.push([7,6]);
if(piece==='K' && castlingRights.white.Q && board[7][1]==='' && board[7][2]==='' && board[7][3]==='') moves.push([7,2]);
if(piece==='k' && castlingRights.black.K && board[0][5]==='' && board[0][6]==='') moves.push([0,6]);
if(piece==='k' && castlingRights.black.Q && board[0][1]==='' && board[0][2]==='' && board[0][3]==='') moves.push([0,2]);
return moves;
}

// --- Drag & Drop ---
function mouseDown(e){
draggedElement=e.target;
draggedPiece={row:+draggedElement.dataset.row,col:+draggedElement.dataset.col};
const legal=getLegalMoves(draggedPiece.row,draggedPiece.col);
drawBoard(legal);
document.addEventListener('mousemove',mouseMove);
document.addEventListener('mouseup',mouseUp);
}

function mouseMove(e){
draggedElement.style.left=e.pageX-boardEl.getBoundingClientRect().left-32+'px';
draggedElement.style.top=e.pageY-boardEl.getBoundingClientRect().top-32+'px';
}

function mouseUp(e){
const col=Math.floor((e.pageX-boardEl.getBoundingClientRect().left)/64);
const row=Math.floor((e.pageY-boardEl.getBoundingClientRect().top)/64);
if(row>=0 && row<8 && col>=0 && col<8){
const legal=getLegalMoves(draggedPiece.row,draggedPiece.col);
if(legal.some(pos=>pos[0]===row && pos[1]===col)){
let pieceMoved=board[draggedPiece.row][draggedPiece.col];
board[row][col]=pieceMoved;
board[draggedPiece.row][draggedPiece.col]='';
moveHistory.push(`${pieceMoved}: ${draggedPiece.row},${draggedPiece.col} â†’ ${row},${col}`);

// Pawn promotion (simplified: always to Queen)
if(pieceMoved==='P' && row===0) board[row][col]='Q';
if(pieceMoved==='p' && row===7) board[row][col]='q';

// Update castling rights
if(pieceMoved==='K'){ castlingRights.white.K=false; castlingRights.white.Q=false; }
if(pieceMoved==='k'){ castlingRights.black.K=false; castlingRights.black.Q=false; }

// Castling move
if(pieceMoved==='K' && draggedPiece.col===4 && col===6){ board[7][5]='R'; board[7][7]='';}
if(pieceMoved==='K' && draggedPiece.col===4 && col===2){ board[7][3]='R'; board[7][0]='';}
if(pieceMoved==='k' && draggedPiece.col===4 && col===6){ board[0][5]='r'; board[0][7]='';}
if(pieceMoved==='k' && draggedPiece.col===4 && col===2){ board[0][3]='r'; board[0][0]='';}

currentTurn=currentTurn==='white'?'black':'white';
}
}
draggedElement=null;
draggedPiece=null;
drawBoard();
}

// --- Init ---
drawBoard();
</script>
</body
